<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BlazePose Web2</title>
  <style>
    body {
      text-align: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                     'Apple Color Emoji', 'Segoe UI Emoji', Arial, sans-serif;
      font-size: 16px;
      color: #111;
      background-color: #fff;
      margin: 0;
      padding: 0;
    }

    #container {
      position: relative;
      display: inline-block;
      margin: 0 auto;
      border: 2px dashed #ccc;
      width: 640px;
      height: 480px; /* âœ… ì˜ìƒ/ìº”ë²„ìŠ¤ í¬ê¸°ì™€ ë°˜ë“œì‹œ ì¼ì¹˜! */

    }

    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
      width: 640px;
      height: 480px;
    }

    canvas {
      z-index: 1;
    }

    #controls {
      margin-top: 10px;
    }

    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2> Realtime blaze pose13</h2>

  <div id="container">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
  </div>
  <div style="margin-bottom: 10px;">
    <label for="username">ì´ë¦„: </label>
    <input type="text" id="username" placeholder="í™ê¸¸ë™" style="font-size: 16px; padding: 5px;">
  </div>

  <div id="controls">
    <button onclick="startRecording()">ğŸ”´ Start</button>
    <button onclick="stopRecording()">â¹ï¸ End</button>
  </div>
  <div id="status" style="margin-top: 10px; font-weight: bold; font-size: 16px;"></div>

  <!-- TensorFlow + BlazePose -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let recording = false;
    let csvData = [];

    const keypointNames = [
      "nose","left_eye","right_eye","left_ear","right_ear",
      "left_shoulder","right_shoulder","left_elbow","right_elbow",
      "left_wrist","right_wrist","left_hip","right_hip",
      "left_knee","right_knee","left_ankle","right_ankle",
      "left_heel","right_heel","left_foot_index","right_foot_index",
      "left_pinky","right_pinky","left_index","right_index",
      "left_thumb","right_thumb","left_eye_inner","left_eye_outer",
      "right_eye_inner","right_eye_outer","mouth_left","mouth_right"
    ];

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        return new Promise(resolve => {
          video.onloadedmetadata = () => {
            // ë¹„ë””ì˜¤ì˜ ì‹¤ì œ í•´ìƒë„ë¡œ ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            resolve(video);
          };
        });
    }

    async function main() {
      await setupCamera();

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      video.width = video.videoWidth;
      video.height = video.videoHeight;
      const detector = await poseDetection.createDetector(poseDetection.SupportedModels.BlazePose, {
        runtime: 'mediapipe',
        solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/pose',
        modelType: 'lite'
      });
      const isMobile = /Android|iPhone/i.test(navigator.userAgent);
      const shouldFlip = !isMobile;

      const render = async () => {
        const poses = await detector.estimatePoses(video);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        if (poses.length > 0 && poses[0].keypoints) {
            poses[0].keypoints.forEach((kp, i) => {
              if (kp.score > 0.4) {
                // ğŸ”´ ì  ê·¸ë¦¬ê¸°
                ctx.beginPath();
                ctx.arc(kp.x, kp.y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = 'red';
                ctx.fill();
        
                // ğŸ”µ ì´ë¦„ í‘œì‹œ
                ctx.font = '10px sans-serif';
                ctx.fillStyle = 'blue';
                ctx.fillText(keypointNames[i], kp.x + 6, kp.y + 6);
              }
            });
          }
      
        ctx.restore();
        requestAnimationFrame(render);
      };

      render();
    }

    function startRecording() {
      recording = true;
      csvData = [];
      
      const status = document.getElementById('status');
      status.innerText = 'ğŸ“¡ ë ˆì½”ë”© ì¤‘...';
      status.style.color = 'red';
    }

    
    function stopRecording() {
      recording = false;

      // ìƒíƒœ í‘œì‹œ ì§€ìš°ê¸°
      const status = document.getElementById('status');
      status.innerText = '';

      // ğŸ“Œ ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
      const username = document.getElementById('username').value.trim() || 'unknown';

      // â° í˜„ì¬ ì‹œê°„ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD-HH-MM)
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const timestamp = `${yyyy}-${mm}-${dd}-${hh}-${min}`;

      // ğŸ“ íŒŒì¼ëª… ìƒì„±
      const filename = `${username}_${timestamp}.csv`;

      // ğŸ“„ CSV ìƒì„±
      let header = [];
      keypointNames.forEach(name => {
        header.push(`${name}_x`, `${name}_y`, `${name}_score`);
      });

      let csvContent = [header.join(',')];
      csvData.forEach(row => {
        csvContent.push(row.join(','));
      });

      const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }


    main();
  </script>
</body>
</html>
